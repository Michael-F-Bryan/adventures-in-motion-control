language: rust
cache: cargo

before_script:
  - set -e

matrix:
  include:

  # Make sure the WASM frontend compiles
  - rust: beta
    env: 
      - RUST_BACKTRACE=1
      - TARGET=wasm32-unknown-unknown
    before_script:
      - (test -x $HOME/.cargo/bin/cargo-install-update || cargo install cargo-update)
      - (test -x $HOME/.cargo/bin/cargo-generate || cargo install --vers "^0.2" cargo-generate)
      - cargo install-update -a
      - rustup target add $TARGET
    script:
      - cargo generate --git . --name testing
      - mv Cargo.toml Cargo.toml.tmpl
      - cd testing
      - cargo check
      - cargo check --target $TARGET
      - cargo check                  --no-default-features
      - cargo check --target $TARGET --no-default-features
      - cargo check                  --no-default-features --features console_error_panic_hook
      - cargo check --target $TARGET --no-default-features --features console_error_panic_hook

  # And the rest of the project
  - rust: nightly
    env: RUST_BACKTRACE=1
    script:
      - cargo build --all --verbose
      - cargo test --all --verbose
    before_deploy:
      - cargo doc --verbose
      - echo '<head><meta http-equiv="refresh" content="0; URL=aimc_hal/index.html" /></head>' > target/doc/index.html

deploy:
  - provider: pages
    skip-cleanup: true
    github-token: "$GITHUB_TOKEN"
    keep-history: false
    local-dir: target/doc
    on:
      branch: master
      rust: nightly

notifications:
  email:
    on_success: never
